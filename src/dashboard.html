<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Segurança</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/dashboard.css"> 
</head>
<body>

  <!-- Menu -->
  <nav class="navbar">
      <button class="back-btn" onclick="history.back()">
          <i class="fa-solid fa-arrow-left"></i>
      </button>

      <div class="logo">
          <i class="fa-solid fa-shield-halved"></i>
          <span>Os Guardiões</span>
      </div>

      <div class="dropdown-user" id="menuBtn">
          <i class="fa-solid fa-bars"></i>
      </div>

      <div class="dropdown-content" id="dropdownMenu">
          <a href="profile.html">Meu Perfil</a>
          <a href="politics.html">Política de Privacidade</a>
      </div>
  </nav>

  <br>

  <div class="dashboard-wrapper">
    <header>Ranking de Segurança</header>

    <div class="dashboard">
      <table id="ranking-table">
        <tr>
          <th>Posição</th>
          <th>Bairro</th>
          <th>Nível de Segurança</th>
        </tr>
      </table>

      <div class="info-boxes">
        <div class="info-box">
          Bairro mais Seguro <span id="mais-seguro">...</span>
        </div>
        <div class="info-box">
          Bairro mais Perigoso <span id="mais-perigoso">...</span>
        </div>
      </div>

      <div class="chart" id="chart"></div>
      <div class="chart-labels" id="chart-labels"></div>
    </div>
  </div>

  <!--Scripts-->
  <script>
    const menuBtn = document.getElementById('menuBtn');
    const dropdownMenu = document.getElementById('dropdownMenu');

    menuBtn.addEventListener('click', () => {
        dropdownMenu.classList.toggle('show');
    });

    window.addEventListener('click', (event) => {
        if (!menuBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
        dropdownMenu.classList.remove('show');
        }
    });
  </script>

  <script>
    const backBtn = document.querySelector('.back-btn');
    if (window.location.pathname.endsWith('index.html')) {
        backBtn.style.display = 'none';
    }
  </script>

  <!-- SCRIPT DINÂMICO PARA MONTAR O RANKING -->
  <script>
  async function carregarRanking() {
    const response = await fetch("http://localhost:3000/occurrences");
    const ocorrencias = await response.json();

    const tabela = document.getElementById("ranking-table");
    const chart = document.getElementById("chart");
    const chartLabels = document.getElementById("chart-labels");

    const spanMaisSeguro = document.getElementById("mais-seguro");
    const spanMaisPerigoso = document.getElementById("mais-perigoso");

    const contagem = {};

    ocorrencias.forEach(o => {
      if (!o.bairro) return;
      contagem[o.bairro] = (contagem[o.bairro] || 0) + 1;
    });

    const ranking = Object.entries(contagem)
      .map(([bairro, total]) => ({ bairro, total }))
      .sort((a, b) => b.total - a.total);

    function nivel(total) {
      if (total === 0) return "Alta";
      if (total <= 1) return "Média";
      return "Baixa";
    }

    // LIMPA
    chart.innerHTML = "";
    chartLabels.innerHTML = "";

    // PREENCHER TABELA
    ranking.forEach((item, index) => {
      tabela.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${item.bairro}</td>
          <td>${nivel(item.total)}</td>
        </tr>
      `;

      chart.innerHTML += `<div class="bar" style="height:${item.total * 10}px">${item.total}</div>`;
      chartLabels.innerHTML += `<div class="bar-label">${item.bairro}</div>`;
    });

    // MAIS PERIGOSO = maior número de ocorrências
    spanMaisPerigoso.innerText = ranking[0]?.bairro || "-";

    // MAIS SEGURO = menor número de ocorrências
    spanMaisSeguro.innerText = ranking[ranking.length - 1]?.bairro || "-";
  }

  carregarRanking();
  </script>

</body>
</html>
